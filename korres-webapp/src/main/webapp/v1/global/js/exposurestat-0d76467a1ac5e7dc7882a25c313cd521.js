!function(t){tuan800ued.addModule("exposureStat",{statConf:{selector:"",crosswise:3,numPerstat:6,dealHeight:0,picSrc:"http://analysis.tuanimg.com/v1/ju/index/img/bgl.gif",locationUrl:window.location.href.replace(/\?.*/,""),page:function(){var t=window.location.href.split("?")[0];return t.indexOf("page/")>-1?t.split("/").pop():1}(),urlPrefix:"",noselectNum:0},exposureDeals:{},init:function(){function e(){for(var t in a.exposureDeals)a.exposureDeals.hasOwnProperty(t)&&a.exposureDeals[t].trigger("exposure",a)}function s(){var e,s="";return""==t.cookie("ppinf")?s:(e=t.parseJSON(Base64.decode(t.cookie("ppinf").split("|")[3]))||{},s=e.uid||"")}if(!exposureConf)return!1;var a=this;this.exposureDeals={},t.extend(!0,this.statConf,exposureConf),this.statConf.selector="div."+exposureConf.selector+" > .deal";var o=t(this.statConf.selector);if(0!=o.length){this.statConf.$deals=o,this.statConf.dealHeight=t(o[0]).find(".con").height(),this.noselectNum=o.first().index();var i=0;if(0!==this.noselectNum){var n=Math.ceil(this.noselectNum/this.statConf.crosswise);0!==this.noselectNum%this.statConf.numPerstat&&(n+=0===n%2?0:1,i=n*this.statConf.crosswise-this.noselectNum,$d=t(o[i-1]),$d.length>0&&($d.addClass("exposure").attr("data-exposure",i),this.exposureDeals[$d.data("id")||""]=$d))}for(var r=this.statConf.numPerstat-1,d=o.length;d>r;r+=this.statConf.numPerstat){var l=t(o[r+i]);l.addClass("exposure").attr("data-exposure",r+1+i),this.exposureDeals[l.data("id")||""]=l}o.last().hasClass("exposure")||(o.last().addClass("exposure").attr("data-exposure",o.length),this.exposureDeals[o.last().data("id")||""]=o.last()),t("div."+exposureConf.selector).delegate(this.statConf.selector,"exposure",this.dealStat),t(document).ready(function(){setTimeout(function(){a.statConf.urlPrefix=a.statConf.picSrc+"?url="+a.statConf.locationUrl+"&page="+a.statConf.page+"&utma="+t.cookie("__utma")+"&version="+t.cookie("ju_version")+"&ju_rv="+t.cookie("ju_rv")+"&session_id="+t.cookie("session_id")+"&tao800_user_id="+s(),t(window).unbind("scroll.go").bind("scroll.go",function(){e()}),e()},0)})}},addStatPic:function(){if(0===t("#exstat").length){var e="<img id='exstat' src='' style='width: 0px;height : 0px'>";t("body").append(e)}},dealStat:function(e,s){var a=t(this),o=t(window).scrollTop()+window.screen.availHeight-a.find(".con").offset().top,i=window.screen.availHeight+s.statConf.dealHeight;if(o>s.statConf.dealHeight&&i>o&&"none"!=a.css("display")){if(!s.exposureDeals[a.data("id")])return;delete s.exposureDeals[a.data("id")];var n=a.data("exposure"),r=s.createDivParam(n),d=document.createElement("img");d.src=s.statConf.urlPrefix+r,d.onload=function(){t(this).remove()},document.body.appendChild(d)}},createDivParam:function(e){var s="&div={'deals':[",a=Math.ceil((e+this.noselectNum)/this.statConf.crosswise),o=0===a%2?a-1:a,i=(e+this.noselectNum)%this.statConf.numPerstat,n=0===i?this.statConf.numPerstat:i,r=[],d=e<this.statConf.numPerstat&&0!==this.noselectNum?this.statConf.numPerstat-e+1:1;for(d;n>=d;d++)if(3>=d){var l=(o-1)*this.statConf.crosswise+d-1-this.noselectNum,u=t(this.statConf.$deals[l]),c=u.data("id"),f=1===u.data("type")?1:0;r.push("{'id':'"+c+"','sourcetype':'"+f+"','x':"+o+",'y':"+d+"}")}else{var l=(a-2)*this.statConf.crosswise+d-1-this.noselectNum,u=t(this.statConf.$deals[l]),c=u.data("id"),f=1===u.data("type")?1:0;r.push("{'id':'"+c+"','sourcetype':'"+f+"','x':"+a+",'y':"+(d-3)+"}")}return s+r.join(",")+"]}"},appendToExposure:function(e){var s=parseInt(t(".exposure").last().data("exposure"));s=s?s:0;for(var a=this.statConf.numPerstat-1,o=e.length;o>a;a+=this.statConf.numPerstat){var i=t(e[a]);i.addClass("exposure").attr("data-exposure",a+1+s),this.exposureDeals[i.data("id")]=i}var e=t(this.statConf.selector);e.last().hasClass("exposure")||(e.last().addClass("exposure").attr("data-exposure",e.length),this.exposureDeals[e.last().data("id")||""]=e.last()),this.statConf.$deals=e}})}(jQuery);