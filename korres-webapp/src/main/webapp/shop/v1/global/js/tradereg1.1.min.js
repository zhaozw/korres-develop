(function(a){tuanpub.addModule("regDialog",{tips:{MOBILE:{DEFAULT:"请输入常用的手机号",NULL:"请输入手机号",INVALID:"手机号格式错误",EXIST:"手机号已存在"},CAPTCHA:{DEFAULT:"验证码",NULL:"请输入验证码",INVALID:"验证码错误，请重试",MAXNUM:"发送验证码过于频繁，请稍后再试",ORIGIN:"发送验证码",REPEAT:"重发验证码"},PASSWORD:{NULL:"请输入密码",MINLENGTH:"密码过短，请输入6-24位字符",MAXLENGTH:"密码过长，请输入6-24位字符",NUMBER:"密码不能使用纯数字",EMPTY:"密码不能包含空格"},CONFIRM:{NULL:"确认密码不能为空",MINLENGTH:"密码过短，请输入6-24位字符",MAXLENGTH:"密码过长，请输入6-24位字符",NUMBER:"密码不能使用纯数字",EMPTY:"密码不能包含空格",NOTEQUAL:"密码不一致，请重试"}},renderForm:function(e,b){var d=new a.Buffers(),c=this;
this.source=e;this.index=b||0;d.push('<form method="post" name="regform">');d.push('<div class="signupnewbox">');d.push('<h3><span>注册折800—享独家折扣</span><a class="loglink" href="javascript:void(0)">立即登录</a></h3>');
d.push('<input type="hidden" id="reg_authenticity_token" value="">');d.push('<ul class="clear">');d.push('<li class="name">');d.push("<div>");d.push("<label>手机号码</label>");
d.push('<input id="reg_mobile" type="text" class="txt1" value="请输入常用的手机号" title="请输入常用的手机号">');d.push("<ins></ins></div></li>");d.push('<li class="password">');
d.push("<div>");d.push("<label>设置密码</label>");d.push('<input id="txt_password" type="text" class="txt1" value="6-24位字符，不能是纯数字">');d.push('<input id="reg_password" type="password" class="txt1" value="" style="display:none" maxlength="24">');
d.push("<ins></ins></div></li>");d.push('<li class="password">');d.push("<div>");d.push("<label>确认密码</label>");d.push('<input id="txt_confirmpwd" type="text" class="txt1" value="请再次输入密码">');
d.push('<input id="reg_confirmpwd" type="password" class="txt1" value="" style="display:none" maxlength="24">');d.push("<ins></ins></div></li>");d.push('<li class="captcha_box token">');
d.push("<div>");d.push('<input id="reg_captcha" type="text" class="txt1" disableautocomplete="" autocomplete="off" name="captcha" title="验证码" value="验证码"></div>');
d.push('<a id="send_reg_captcha" href="javascript:void(0)">发送验证码</a></li>');d.push('<li class="btn"><input id="reg_submit" type="button" value="同意协议并注册" class="sign"></li>');
d.push('<li class="txt"><span><a href="http://www.zhe800.com/service_terms" target="_blank">《折800用户注册协议》</a></span>');d.push('<a href="https://passport.zhe800.com/users/signup?return_to='+window.location.href+'" target="_blank">邮箱注册&gt;&gt;</a></li>');
d.push("</ul></div></form>");a.Dialogs({id:"dialog_reg_qiandao",overlay:true,auto:false,msg:d.toString(),openfun:function(){c.bindEvents();},closefun:function(){a(".dialog-overlay").remove();
}});},addValidClass:function(c,b){if(b){c.addClass("warn1");c.removeClass("warn2");}else{c.addClass("warn2");c.removeClass("warn1");}},addUpplerClass:function(c,b){if(b){c.addClass("warn3");
}else{c.removeClass("warn3");}},appendError:function(c,b){c.find("span.err").remove().end().append('<span class="err">'+b+"</span>");},isError:function(c,b){if(c.find("span.err").size()===1&&c.find("span.err").text()===b){return true;
}return false;},removeError:function(b){b.find("span.err").remove();},switchLogin:function(){var b=this;a("#dialog_reg_qiandao").delegate(".loglink","click",function(d){a("#dialog_reg_qiandao .close").trigger("click");
if(b.source==="qd"){var c=tuanpub.getModule("dialogPP");c.init();}else{a("#login-panel").parents("div.tab-tip").css({opacity:1,right:"34px",display:"block"});
}d.preventDefault();});},checkMobile:function(c){var b=this;c.focus(function(){if(a(this).val()==b.tips.MOBILE.DEFAULT){a(this).val("");}a(this).removeClass("change").addClass("change");
}).blur(function(){var d=this,f=a(d).val(),e=a(d).parents("li");b.removeError(e);b.addValidClass(e,true);if(f.length===0||f==b.tips.MOBILE.DEFAULT){b.appendError(e,b.tips.MOBILE.NULL);
a(d).val(b.tips.MOBILE.DEFAULT);b.addValidClass(e,false);a(this).removeClass("change");}else{if(tuanpub.verification.mobile(f).status!=0){b.appendError(e,b.tips.MOBILE.INVALID);
b.addValidClass(e,false);}else{b.ajaxCheckMobile(f,function(g){if(!g||g.status!==200){b.appendError(e,b.tips.MOBILE.EXIST+'，<a class="loglink" href="javascript:void(0)">立即登录</a>');
b.addValidClass(e,false);}});}}});},checkPassword:function(d,f,e,b){var c=this;f.removeClass("change").addClass("change");b.removeClass("change").addClass("change");
d.focus(function(){var h=this,g=a(h).next();a(h).hide();g.val("").show().focus();});e.focus(function(){var h=this,g=a(h).next();a(h).hide();g.val("").show().focus();
});f.blur(function(){var h=this,k=a(h).val(),j=a(h).parents("li"),g=a(h).prev();c.removeError(j);c.addValidClass(j,true);c.addUpplerClass(j,false);if(k.length===0){a(h).hide();
g.show();c.appendError(j,c.tips.PASSWORD.NULL);c.addValidClass(j,false);}else{if(k.length<6){c.appendError(j,c.tips.PASSWORD.MINLENGTH);c.addValidClass(j,false);
}else{if(k.length>24){c.appendError(j,c.tips.PASSWORD.MAXLENGTH);c.addValidClass(j,false);}else{if(/^\d+$/.test(k)){c.appendError(j,c.tips.PASSWORD.NUMBER);
c.addValidClass(j,false);}else{if(b.val().length>0){b.trigger("blur");}}}}}}).keyup(function(){var g=this,j=a(g).val(),h=a(g).parents("li");if(/\s$/.test(j)){c.appendError(h,c.tips.PASSWORD.EMPTY);
c.addValidClass(h,false);a(g).val(j.trim());return;}else{if(c.isError(h,c.tips.PASSWORD.EMPTY)){c.removeError(h);c.addValidClass(h,true);}}if(/[A-Z]/.test(j)){c.addUpplerClass(h,true);
}else{c.addUpplerClass(h,false);}});b.blur(function(){var h=this,k=a(h).val(),j=a(h).parents("li"),g=a(h).prev();c.removeError(j);c.addValidClass(j,true);
c.addUpplerClass(j,false);if(k.length===0){a(h).hide();g.show();c.appendError(j,c.tips.CONFIRM.NULL);c.addValidClass(j,false);}else{if(k.length<6){c.appendError(j,c.tips.CONFIRM.MINLENGTH);
c.addValidClass(j,false);}else{if(k.length>24){c.appendError(j,c.tips.CONFIRM.MAXLENGTH);c.addValidClass(j,false);}else{if(/^\d+$/.test(k)){c.appendError(j,c.tips.CONFIRM.NUMBER);
c.addValidClass(j,false);}else{if(k!=f.val()){c.appendError(j,c.tips.CONFIRM.NOTEQUAL);c.addValidClass(j,false);}}}}}}).keyup(function(){var g=this,j=a(g).val(),h=a(g).parents("li");
if(/\s$/.test(j)){c.appendError(h,c.tips.CONFIRM.EMPTY);c.addValidClass(h,false);a(g).val(j.trim());return;}else{if(c.isError(h,c.tips.CONFIRM.EMPTY)){c.removeError(h);
c.addValidClass(h,true);}}if(/[A-Z]/.test(j)){c.addUpplerClass(h,true);}else{c.addUpplerClass(h,false);}});},checkCaptcha:function(b){var c=this;b.focus(function(){if(a(this).val()==c.tips.CAPTCHA.DEFAULT){a(this).val("");
}a(this).removeClass("change").addClass("change");}).blur(function(){var d=this,f=a(d).val(),e=a(d).parents("li");c.removeError(e);c.addValidClass(e,true);
if(f.length===0||f==c.tips.CAPTCHA.DEFAULT){c.appendError(e,c.tips.CAPTCHA.NULL);a(d).val(c.tips.CAPTCHA.DEFAULT);c.addValidClass(e,false);a(this).removeClass("change");
}});},sendCaptcha:function(d,c){var b=this;this.clickable=true;d.click(function(){var e=this,g=a(e).parents("li"),f=c.parents("li");d.attr("disabled","disabled");
if(b.clickable){b.clickable=false;}else{return;}b.ajaxCheckMobile(c.val(),function(j){var h=true;if(j&&j.status==400){h=false;}else{if(j&&j.status==200){if(c.val().length===0||c.val()==b.tips.MOBILE.DEFAULT){h=false;
}else{if(tuanpub.verification.mobile(c.val()).status!=0){h=false;}}}}if(!h){c.trigger("blur");d.removeAttr("disabled");b.clickable=true;return;}b.ajaxGetAuthToken(function(k){var m=120,l=1000,n;
if(!k||!k.authenticity_token){a(e).val(b.tips.CAPTCHA.ORIGIN);b.addValidClass(g,false);d.removeAttr("disabled");b.clickable=true;return;}a("#reg_authenticity_token").val(k.authenticity_token);
n=tuan800ued.addTimeout(m,l,function(o){a(e).html("重发验证码( "+(o<10?"0".concat(o):o)+"秒 )").css("cursor","default");},function(){clearInterval(n);counter=m;
a(e).html(b.tips.CAPTCHA.REPEAT).css("cursor","pointer");d.removeAttr("disabled");b.clickable=true;});b.ajaxSendCaptcha(c.val(),(new Date()).getTime(),k.authenticity_token,function(o){if(o.status===0){if(o.errors){if(o.errors.phone_number){c.trigger("blur");
}if(o.errors.phone_confirmation){b.appendError(g,b.tips.CAPTCHA.MAXNUM);a(e).val(b.tips.CAPTCHA.REPEAT);b.addValidClass(g,false);}}}});});});});},startRegister:function(){var b=this;
a("#reg_submit").click(function(){a(this).attr("disabled","disabled");b.checkForm();});},checkForm:function(){var c=this,b=c.getElements();for(var d in b){b[d].trigger("blur");
}if(!!a(".signupnewbox").find(".err")[0]){a("#reg_submit").removeAttr("disabled");return;}c.register();},loginSuccessCall:function(){PassportCardList[this.index].autoProcAllDomain("login",a("body"));
PassportCardList[this.index].getBottomRow();PassportCardList[this.index].drawPassportCard();for(i=0;i<PassportCardList.length;i++){if(i==PassportCardList[this.index].curCardIndex){continue;
}PassportCardList[i].parsePassportCookie();PassportCardList[i].getBottomRow();PassportCardList[i].drawPassportCard();}a("#dialog_reg_qiandao .close").trigger("click");
},register:function(){var b=this;b.ajaxSubmitRegister(b.getRegInfo(),function(c){if(c.status==1){a.getScript(c.return_to,function(){if(login_status=="success"){b.loginSuccessCall();
tuanpub.queue(tuanpub.headQueue);}});}if(c.status==0){if(c.errors&&c.errors.captcha){var d=b.getElements().captcha,f=a(d).val(),e=a(d).parents("li");b.removeError(e);
b.addValidClass(e,true);b.appendError(e,b.tips.CAPTCHA.INVALID);b.addValidClass(e,false);}if(c.errors&&c.errors.phone_number){var d=b.getElements().mobile,f=a(d).val(),e=a(d).parents("li");
b.removeError(e);b.addValidClass(e,true);b.appendError(e,b.tips.MOBILE.EXIST+'，<a class="loglink" href="javascript:void(0)">立即登录</a>');b.addValidClass(e,false);
}}a("#reg_submit").removeAttr("disabled");},"json");},bindEvents:function(){var d=this,h=d.getElements().mobile,e=d.getElements().tipsPwd,j=d.getElements().pwd,f=d.getElements().tipsConfirm,c=d.getElements().confirm,b=d.getElements().captcha,g=d.getElements().sendCaptcha;
d.switchLogin();d.checkMobile(h);d.checkPassword(e,j,f,c);d.checkCaptcha(b);d.sendCaptcha(g,h);d.startRegister();},getElements:function(){return{mobile:a("#reg_mobile"),tipsPwd:a("#txt_password"),pwd:a("#reg_password"),tipsConfirm:a("#txt_confirmpwd"),confirm:a("#reg_confirmpwd"),captcha:a("#reg_captcha"),sendCaptcha:a("#send_reg_captcha")};
},getRegInfo:function(){var b=this;return{username:b.getElements().mobile.val(),password:b.getElements().pwd.val(),captcha:b.getElements().captcha.val(),platform:"www",regtype:"mobile",agreement:true,subscribe_status:0,authenticity_token:a("#reg_authenticity_token").val(),password_confirmation:b.getElements().confirm.val(),domain:"zhe800.com",popup:1};
},ajaxCheckMobile:function(b,c){a.getJSON("/users/check_username",{username:b},function(d){c(d);});},ajaxGetAuthToken:function(b){a.getJSON("/users/register_access",function(c){b(c);
});},ajaxSendCaptcha:function(b,d,c,e){a.post("/users/passport/send_phone_confirmations",{phone_number:b,timestamp:d,authenticity_token:c},function(f){e(f);
});},ajaxSubmitRegister:function(c,b){a.post("/users.json",c,function(d){b(d);});}});})(jQuery);